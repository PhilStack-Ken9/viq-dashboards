<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoterIQ Integrated Trend Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" onerror="this.src='/static/vendor/xlsx.full.min.js'"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" onerror="this.src='/static/vendor/chart.min.js'"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" onerror="this.src='/static/vendor/html2canvas.min.js'"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" onerror="this.src='/static/vendor/jspdf.umd.min.js'"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .dashboard-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.1);
        }
        .kpi-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }
        .kpi-card.youtube {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .kpi-card.rag {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .data-card {
            background: white;
            border-radius: 15px;
            padding: 24px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            margin-bottom: 24px;
        }
        .tab-button {
            transition: all 0.3s ease;
            font-weight: 600;
            padding: 0.75rem 2rem;
            border-radius: 9999px; /* rounded-full */
            color: #4B5563; /* text-gray-600 */
        }
        .tab-button.active {
            background-color: white;
            color: #3B82F6; /* text-blue-600 */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .status-online {
            width: 10px;
            height: 10px;
            background: #10B981;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .data-freshness {
            font-size: 0.875rem;
            color: #4B5563;
        }
        .keyword-cloud {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 16px;
            max-height: 300px;
            overflow-y: auto;
        }
        .keyword-tag {
            background: #E5E7EB;
            color: #374151;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            margin: 4px;
            display: inline-block;
            transition: all 0.3s ease;
        }
        .keyword-tag:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        .keyword-tag.positive {
            background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%);
            color: #065F46;
        }
        .keyword-tag.negative {
            background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%);
            color: #991B1B;
        }
        .keyword-tag.neutral {
            background: linear-gradient(135deg, #E0E7FF 0%, #C7D2FE 100%);
            color: #3730A3;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .chart-container canvas {
            max-height: 300px !important;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .display-limit-selector {
            padding: 0.5rem 0.75rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.5rem;
            background-color: white;
            font-size: 0.875rem;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .display-limit-selector:hover {
            border-color: #3B82F6;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .display-limit-selector:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        @media (max-width: 768px) {
            .chart-container {
                height: 250px;
            }
            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            .display-limit-selector {
                font-size: 0.8rem;
                padding: 0.4rem 0.6rem;
            }
            .tab-button {
                padding: 0.5rem 1rem;
                font-size: 0.875rem;
            }
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">
    <div class="dashboard-container max-w-7xl mx-auto p-6 md:p-8" id="dashboard-content">
        <div class="text-center mb-8">
            <h1 class="text-5xl font-bold mb-4 bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent">
                VoterIQ Integrated Trend Analysis
            </h1>
            <p class="text-xl text-gray-600 mb-6">
                Comprehensive dashboard showing poll sentiment, YouTube analysis, and AI-powered RAG system.
            </p>
            <div class="flex justify-center items-center flex-wrap gap-4">
                <div class="flex items-center data-freshness">
                    <span class="status-online"></span>
                    <span id="data-freshness">Last updated: Loading...</span>
                </div>
                <button onclick="refreshData(event)" class="bg-blue-500 text-white px-6 py-2 rounded-full shadow hover:bg-blue-600 text-sm font-medium transition-colors">
                    Refresh Data
                </button>
                <button onclick="exportToPDF()" class="bg-indigo-500 text-white px-6 py-2 rounded-full shadow hover:bg-indigo-600 text-sm font-medium transition-colors">
                    Export Integrated Report to PDF
                </button>
            </div>
        </div>

        <div class="flex justify-center mb-8 bg-gray-100 rounded-full shadow-inner p-1">
            <button class="tab-button active" onclick="switchTab('polls', event)">
                Poll Analysis
            </button>
            <button class="tab-button" onclick="switchTab('youtube', event)">
                VoterIQ
            </button>
            <button class="tab-button" onclick="switchTab('rag-insights', event)">
                ASK VoterIQ
            </button>
        </div>

        <div id="polls-tab" class="tab-content active">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="kpi-card p-6 text-center">
                    <h3 class="text-xl font-semibold">Overall TDP Support</h3>
                    <p id="tdp-support" class="text-4xl font-bold mt-2">--</p>
                </div>
                <div class="kpi-card p-6 text-center">
                    <h3 class="text-xl font-semibold">Overall YSRCP Support</h3>
                    <p id="ysrcp-support" class="text-4xl font-bold mt-2">--</p>
                </div>
                <div class="kpi-card p-6 text-center">
                    <h3 class="text-xl font-semibold">Swing Voter %</h3>
                    <p id="swing-voter" class="text-4xl font-bold mt-2">--</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="data-card">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Key Voter Issues</h2>
                    <div id="poll-issues" class="keyword-cloud">
                        </div>
                </div>
                <div class="data-card">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Support Distribution by Issue</h2>
                    <div class="chart-container">
                        <canvas id="pollIssueChart"></canvas>
                    </div>
                </div>
                <div class="data-card">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Swing Voter Issues</h2>
                    <div id="swing-issues" class="keyword-cloud">
                        </div>
                </div>
                <div class="data-card">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Voter Leaning Breakdown</h2>
                    <div class="chart-container flex justify-center items-center" style="height: 300px;">
                        <canvas id="voterLeaningChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>

            <div class="data-card">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Integrated Analysis Overview</h2>
                <div id="integrated-summary" class="text-gray-700 leading-relaxed">
                    <p>Loading integrated analysis summary...</p>
                </div>
            </div>
        </div>

        <div id="youtube-tab" class="tab-content">
            <div id="youtube-loading" class="hidden flex items-center justify-center p-8 data-card">
                <div class="text-center">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <p class="text-gray-600">Loading VoterIQ analysis data...</p>
                </div>
            </div>
            
            <div id="youtube-error" class="hidden p-8 text-center data-card">
                <div class="bg-red-50 border border-red-200 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-red-800 mb-2">Error Loading YouTube Data</h3>
                    <p class="text-red-600 mb-4" id="youtube-error-message">Failed to load VoterIQ analysis data.</p>
                    <button onclick="loadYouTubeData()" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600">
                        Retry
                    </button>
                </div>
            </div>
            
            <div id="youtube-content">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="kpi-card youtube p-6 text-center">
                        <h3 class="text-lg font-semibold mb-2">Total Videos Analyzed</h3>
                        <div class="text-4xl font-bold" id="youtube-total-videos">--</div>
                    </div>
                    <div class="kpi-card youtube p-6 text-center">
                        <h3 class="text-lg font-semibold mb-2">Total Comments Analyzed</h3>
                        <div class="text-4xl font-bold" id="youtube-total-comments">--</div>
                    </div>
                    <div class="kpi-card youtube p-6 text-center">
                        <h3 class="text-lg font-semibold mb-2">Overall Sentiment Score</h3>
                        <div class="text-4xl font-bold" id="youtube-sentiment-score">--</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="data-card">
                        <div class="section-header">
                            <h2 class="text-2xl font-bold text-gray-800">Top Positive Keywords</h2>
                            <select id="positive-keywords-limit" class="display-limit-selector" onchange="renderPositiveKeywords()">
                                <option value="10" selected>Top 10</option>
                                <option value="all">Show All</option>
                            </select>
                        </div>
                        <div id="youtube-positive-keywords" class="keyword-cloud">
                            </div>
                    </div>
                    <div class="data-card">
                        <div class="section-header">
                            <h2 class="text-2xl font-bold text-gray-800">Top Negative Keywords</h2>
                            <select id="negative-keywords-limit" class="display-limit-selector" onchange="renderNegativeKeywords()">
                                <option value="10" selected>Top 10</option>
                                <option value="all">Show All</option>
                            </select>
                        </div>
                        <div id="youtube-negative-keywords" class="keyword-cloud">
                            </div>
                    </div>
                    <div class="data-card">
                        <div class="section-header">
                            <h2 class="text-2xl font-bold text-gray-800">Mixed Response Keywords</h2>
                            <select id="mixed-keywords-limit" class="display-limit-selector" onchange="renderMixedKeywords()">
                                <option value="10" selected>Top 10</option>
                                <option value="all">Show All</option>
                            </select>
                        </div>
                        <div id="youtube-mixed-keywords" class="keyword-cloud">
                            </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="data-card">
                        <div class="section-header">
                            <h2 class="text-2xl font-bold text-gray-800">Positive Political Issues</h2>
                            <select id="positive-issues-limit" class="display-limit-selector" onchange="renderPositiveIssues()">
                                <option value="10" selected>Top 10</option>
                                <option value="all">Show All</option>
                            </select>
                        </div>
                        <div id="youtube-positive-issues" class="keyword-cloud">
                            </div>
                    </div>
                    <div class="data-card">
                        <div class="section-header">
                            <h2 class="text-2xl font-bold text-gray-800">Critical Issues</h2>
                            <select id="negative-issues-limit" class="display-limit-selector" onchange="renderNegativeIssues()">
                                <option value="10" selected>Top 10</option>
                                <option value="all">Show All</option>
                            </select>
                        </div>
                        <div id="youtube-negative-issues" class="keyword-cloud">
                            </div>
                    </div>
                    <div class="data-card">
                        <div class="section-header">
                            <h2 class="text-2xl font-bold text-gray-800">Mixed Sentiment Issues</h2>
                            <select id="mixed-issues-limit" class="display-limit-selector" onchange="renderMixedIssues()">
                                <option value="10" selected>Top 10</option>
                                <option value="all">Show All</option>
                            </select>
                        </div>
                        <div id="youtube-mixed-issues" class="keyword-cloud">
                            </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="data-card">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Top 5 Most Positive Issues</h2>
                        <div class="chart-container" style="position: relative; height: 300px;">
                            <canvas id="topPositiveIssuesChart"></canvas>
                            <div class="chart-message hidden"></div>
                        </div>
                    </div>
                    <div class="data-card">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Top 5 Most Negative Issues</h2>
                        <div class="chart-container" style="position: relative; height: 300px;">
                            <canvas id="topNegativeIssuesChart"></canvas>
                            <div class="chart-message hidden"></div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="data-card">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-800">Sentiment Distribution</h2>
                            <select id="sentiment-category-filter" class="display-limit-selector" onchange="renderYouTubeCharts()">
                                <option value="all">All Categories</option>
                                <option value="Infrastructure Development">Infrastructure Development</option>
                                <option value="Agricultural Support">Agricultural Support</option>
                                <option value="Social Welfare Schemes">Social Welfare Schemes</option>
                                <option value="Political Governance">Political Governance</option>
                                <option value="Economic Development">Economic Development</option>
                                <option value="Education & Healthcare">Education & Healthcare</option>
                                <option value="Corruption & Transparency">Corruption & Transparency</option>
                            </select>
                        </div>
                        <div class="chart-container" style="position: relative; height: 300px;">
                            <canvas id="youtubeSentimentChart"></canvas>
                        </div>
                    </div>
                    <div class="data-card">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Analysis Metrics</h2>
                        <div class="space-y-6 pt-4">
                            <div class="text-center">
                                <div class="metric-label text-gray-600">Total Comments Analyzed</div>
                                <div id="youtube-chart-total-comments" class="text-3xl font-bold text-gray-800">--</div>
                            </div>
                            <div class="text-center">
                                <div class="metric-label text-gray-600">Most Common Sentiment</div>
                                <div id="youtube-chart-dominant-sentiment" class="text-3xl font-bold text-gray-800">--</div>
                            </div>
                            <div class="text-center">
                                <div class="metric-label text-gray-600">Sentiment Confidence</div>
                                <div id="youtube-chart-confidence" class="text-3xl font-bold text-gray-800">--</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="data-card">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Issue Priority Matrix</h2>
                    <p class="text-sm text-gray-600 mb-4">Issues plotted by Impact (video count + occurrences) vs Urgency (confidence + sentiment intensity). Bubble size represents occurrence count.</p>
                    <div class="chart-container" style="position: relative; height: 500px;">
                        <canvas id="issuePriorityMatrix"></canvas>
                    </div>
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-4 gap-2 text-sm">
                        <div class="p-2 bg-red-100 border border-red-300 rounded">
                            <strong>🔴 Critical:</strong> High impact, high urgency - Act now
                        </div>
                        <div class="p-2 bg-yellow-100 border border-yellow-300 rounded">
                            <strong>🟡 Important:</strong> High impact, low urgency - Plan action
                        </div>
                        <div class="p-2 bg-orange-100 border border-orange-300 rounded">
                            <strong>🟠 Emerging:</strong> Low impact, high urgency - Watch closely
                        </div>
                        <div class="p-2 bg-green-100 border border-green-300 rounded">
                            <strong>🟢 Low Priority:</strong> Low impact, low urgency - Track only
                        </div>
                    </div>
                </div>

                <div class="data-card">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Issue Severity by Category</h2>
                    <p class="text-sm text-gray-600 mb-4">Distribution of issues across categories and severity levels.</p>
                    <div id="severity-heatmap" class="overflow-x-auto">
                        </div>
                </div>

                <div class="data-card">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Top 10 Critical Issues</h2>
                    <div class="mb-4 flex flex-wrap gap-4">
                        <select id="severity-filter" class="display-limit-selector" onchange="renderCriticalIssuesTable()">
                            <option value="all">All Severities</option>
                            <option value="critical">Critical Only</option>
                            <option value="high">High Only</option>
                            <option value="medium">Medium Only</option>
                            <option value="low">Low Only</option>
                        </select>
                        <select id="category-filter" class="display-limit-selector" onchange="renderCriticalIssuesTable()">
                            <option value="all">All Categories</option>
                            <option value="Infrastructure Development">Infrastructure</option>
                            <option value="Agricultural Support">Agriculture</option>
                            <option value="Social Welfare Schemes">Social Welfare</option>
                            <option value="Political Governance">Governance</option>
                            <option value="Economic Development">Economy</option>
                            <option value="Education & Healthcare">Education/Health</option>
                            <option value="Corruption & Transparency">Corruption</option>
                        </select>
                        <select id="sentiment-filter" class="display-limit-selector" onchange="renderCriticalIssuesTable()">
                            <option value="all">All Sentiments</option>
                            <option value="positive">Positive Only</option>
                            <option value="negative">Negative Only</option>
                            <option value="neutral">Mixed Only</option>
                        </select>
                    </div>
                    <div id="critical-issues-table" class="overflow-x-auto">
                        </div>
                </div>

                <div class="data-card">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">VoterIQ Analysis Summary</h2>
                    <div id="youtube-narrative" class="text-gray-700 leading-relaxed">
                        <p>Loading YouTube analysis summary...</p>
                    </div>
                </div>

                <div class="data-card">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Political Issues Analysis</h2>
                    <div id="youtube-political-issues-narrative" class="text-gray-700 leading-relaxed">
                        <p>Loading political issues analysis...</p>
                    </div>
                </div>
            </div> </div>


        <div id="rag-insights-tab" class="tab-content">
            <div class="data-card bg-gradient-to-r from-purple-50 to-blue-50">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">AI-Powered Insights</h2>
                <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 mb-4">
                    <input type="text" id="rag-query-input" placeholder="Ask a question about Andhra Pradesh politics..." 
                           class="flex-1 px-4 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm">
                    <button onclick="submitRAGQuery()" class="bg-blue-500 text-white px-8 py-3 rounded-full hover:bg-blue-600 font-semibold shadow-md transition-all">
                        Ask AI
                    </button>
                </div>
                <div id="rag-response" class="bg-white p-4 rounded-lg min-h-[200px] border border-gray-200">
                    <p class="text-gray-500">Enter a question above to get AI-powered insights based on sentiment analysis data from polls and YouTube.</p>
                </div>
            </div>

            <div class="data-card">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Sample Analysis Questions</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button onclick="askSampleQuestion('What is the public sentiment on the Polavaram project?')" 
                            class="text-left p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                        <strong>Polavaram Project:</strong> What is the public sentiment on the Polavaram project?
                    </button>
                    <button onclick="askSampleQuestion('What are the main political issues in Andhra Pradesh?')" 
                            class="text-left p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                        <strong>Political Issues:</strong> What are the main political issues in Andhra Pradesh?
                    </button>
                    <button onclick="askSampleQuestion('How do voters perceive YSRCP governance?')" 
                            class="text-left p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                        <strong>YSRCP Governance:</strong> How do voters perceive YSRCP governance?
                    </button>
                    <button onclick="askSampleQuestion('What infrastructure projects are being discussed?')" 
                            class="text-left p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                        <strong>Infrastructure:</strong> What infrastructure projects are being discussed?
                    </button>
                </div>
            </div>

            <div class="data-card">
                <h3 class="text-xl font-bold text-gray-800 mb-4">RAG System Status</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="kpi-card rag p-6 text-center">
                        <h3 class="text-lg font-semibold mb-2">Documents in Knowledge Base</h3>
                        <p id="rag-documents-count" class="text-4xl font-bold mt-2">--</p>
                    </div>
                    <div class="kpi-card rag p-6 text-center">
                        <h3 class="text-lg font-semibold mb-2">Avg Response Time (ms)</h3>
                        <p id="rag-avg-response-time" class="text-4xl font-bold mt-2">--</p>
                    </div>
                    <div class="kpi-card rag p-6 text-center">
                        <h3 class="text-lg font-semibold mb-2">Success Rate</h3>
                        <p id="rag-success-rate" class="text-4xl font-bold mt-2">--</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Global variables
        let pollData = {};
        let youtubeData = {};
        let ragStatus = {};
        let chartInstances = {};
        // YouTube data is loaded on page load

        // Copy diagnostic command to clipboard
        function copyDiagnosticCommand() {
            const command = 'python diagnose_narratives.py';
            navigator.clipboard.writeText(command).then(() => {
                console.log('Diagnostic command copied to clipboard:', command);
                // Show a temporary success message
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                button.classList.add('bg-green-200', 'text-green-800');
                button.classList.remove('bg-yellow-200', 'text-yellow-800');
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('bg-green-200', 'text-green-800');
                    button.classList.add('bg-yellow-200', 'text-yellow-800');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy command to clipboard:', err);
                alert('Failed to copy command. Please manually copy: python diagnose_narratives.py');
            });
        }

        // Helper function for parsing percentage strings
        function parsePercentage(value) {
            try {
                if (value === null || value === undefined || value === '') {
                    return 0;
                }
                const stringValue = value.toString();
                // Strip all non-numeric characters except sign and decimal
                const cleanedValue = stringValue.replace(/[^0-9.+-]/g, '');
                const numericValue = parseFloat(cleanedValue);
                return isNaN(numericValue) ? 0 : numericValue;
            } catch (error) {
                console.error('Error parsing percentage:', value, error);
                return 0;
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Dashboard initialized');
            fetchAllData();
            setInterval(updateDataFreshness, 30000); // Update every 30 seconds
        });

        // Tab switching functionality
        function switchTab(tabName, evt) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            // Show selected tab
            const targetTab = document.getElementById(tabName + '-tab');
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            if (evt && evt.target) {
                evt.target.classList.add('active');
            }

            // YouTube data is now loaded on page load, no need to load here
        }

        // Fetch all data
        async function fetchAllData() {
            try {
                console.log('Fetching all data...');
                await Promise.all([
                    loadPollData(),
                    loadRAGStatus(),
                    loadYouTubeData()
                ]);
                updateDataFreshness();
                console.log('All data fetched successfully');
            } catch (error) {
                console.error('Error loading initial data:', error);
            }
        }

        // Load poll data
        async function loadPollData() {
            try {
                console.log('Loading poll data...');
                const timestamp = new Date().getTime();
                console.log('Fetching poll file with timestamp:', timestamp);
                
                const response = await fetch('./poll_sentiment_report.xlsx?t=' + timestamp, {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const data = await response.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                
                const summarySheet = workbook.Sheets['Overall Summary'];
                const detailedSheet = workbook.Sheets['Detailed Analysis'];
                
                pollData.summary = summarySheet ? XLSX.utils.sheet_to_json(summarySheet) : [];
                pollData.detailed = detailedSheet ? XLSX.utils.sheet_to_json(detailedSheet) : [];
                
                console.log('Poll data loaded:', pollData);
                renderPollData();
            } catch (error) {
                console.error('Error loading poll data:', error);
                document.getElementById('integrated-summary').innerHTML = 
                    '<p class="text-red-500">Error loading poll data: ' + error.message + '</p>';
            }
        }

        // Load YouTube data
        async function loadYouTubeData() {
            // Show loading state
            document.getElementById('youtube-loading').classList.remove('hidden');
            document.getElementById('youtube-error').classList.add('hidden');
            document.getElementById('youtube-content').classList.add('hidden');
            
            try {
                console.log('Loading YouTube data...');
                const timestamp = new Date().getTime();
                console.log('Fetching Excel file with timestamp:', timestamp);
                
                // Enhanced cache-busting with multiple techniques
                const response = await fetch('./youtube_sentiment_report.xlsx?t=' + timestamp, {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                // Get file modification time from response headers
                const lastModified = response.headers.get('Last-Modified');
                if (lastModified) {
                    const fileDate = new Date(lastModified);
                    const now = new Date();
                    const ageMinutes = Math.floor((now - fileDate) / (1000 * 60));
                    console.log(`Excel file last updated: ${fileDate.toLocaleString()} (${ageMinutes} minutes ago)`);
                    
                    // Display file modification time in UI
                    const freshnessIndicator = document.getElementById('data-freshness');
                    if (freshnessIndicator) {
                        freshnessIndicator.innerHTML = `<span class="status-online"></span>Excel file last updated: ${fileDate.toLocaleString()}`;
                    }
                }
                
                const data = await response.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                
                // Debug: Log all available sheet names
                console.log('All sheet names in workbook:', workbook.SheetNames);
                
                const rawSummary = workbook.Sheets['Overall Summary'] ? XLSX.utils.sheet_to_json(workbook.Sheets['Overall Summary']) : [];
                
                // Convert key-value format to canonical format for dashboard compatibility
                console.log('📊 Raw summary data:', rawSummary);
                youtubeData.summary = convertYouTubeSummaryToCanonical(rawSummary);
                console.log('📈 Processed summary data:', youtubeData.summary);
                
                youtubeData.videos = workbook.Sheets['Video Details'] ? XLSX.utils.sheet_to_json(workbook.Sheets['Video Details']) : [];
                youtubeData.positive_keywords = workbook.Sheets['Positive Keywords'] ? XLSX.utils.sheet_to_json(workbook.Sheets['Positive Keywords']) : [];
                youtubeData.negative_keywords = workbook.Sheets['Negative Keywords'] ? XLSX.utils.sheet_to_json(workbook.Sheets['Negative Keywords']) : [];
                youtubeData.mixed_keywords = workbook.Sheets['Mixed Response Keywords'] ? XLSX.utils.sheet_to_json(workbook.Sheets['Mixed Response Keywords']) : [];
                youtubeData.positive_issues = workbook.Sheets['Positive Issues'] ? XLSX.utils.sheet_to_json(workbook.Sheets['Positive Issues']) : [];
                youtubeData.negative_issues = workbook.Sheets['Negative Issues'] ? XLSX.utils.sheet_to_json(workbook.Sheets['Negative Issues']) : [];
                youtubeData.mixed_issues = workbook.Sheets['Mixed Issues'] ? XLSX.utils.sheet_to_json(workbook.Sheets['Mixed Issues']) : [];
                
                // Debug: Log issues data
                console.log('🔍 Issues data loaded:');
                console.log('Positive issues:', youtubeData.positive_issues.length, 'rows');
                console.log('Negative issues:', youtubeData.negative_issues.length, 'rows');
                console.log('Mixed issues:', youtubeData.mixed_issues.length, 'rows');
                if (youtubeData.positive_issues.length > 0) {
                    console.log('Sample positive issue:', youtubeData.positive_issues[0]);
                    console.log('First positive issue Issue field:', youtubeData.positive_issues[0].Issue);
                    console.log('First positive issue Occurrences field:', youtubeData.positive_issues[0].Occurrences);
                }
                if (youtubeData.negative_issues.length > 0) {
                    console.log('Sample negative issue:', youtubeData.negative_issues[0]);
                    console.log('First negative issue Issue field:', youtubeData.negative_issues[0].Issue);
                }
                
                // Debug: Log the number of videos loaded
                console.log('📊 Videos loaded:', youtubeData.videos.length);
                if (youtubeData.videos.length > 0) {
                    console.log('📺 Last 3 videos:', youtubeData.videos.slice(-3).map(v => v['Video Title']));
                    const ministerVideos = youtubeData.videos.filter(v => v['Video Title'].toLowerCase().includes('minister narayana'));
                    console.log('🎯 Minister Narayana videos found:', ministerVideos.length);
                }
                // Load narrative sheets with enhanced diagnostics
                console.log('Narrative Summary sheet
